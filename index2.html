<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á (S4 & S5)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #0056b3;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-top: 20px;
        }
        .section-header {
            background-color: #eaf6ff;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            background-color: #fff0d9;
            color: #ff8c00;
            font-weight: bold;
            min-height: 40px;
            display: flex;
            align-items: center;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            opacity: 0.9;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #answerHBtn, #answerABtn {
            background-color: #28a745;
            color: white;
        }
        #nextSection5Btn {
            background-color: #007bff;
            color: white;
        }
        #startABtn {
            background-color: #6c757d;
            color: white;
        }
        #finalSaveBtn {
            background-color: #dc3545;
            color: white;
        }
        .audio-controls {
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        
        /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Loading Overlay ‡πÅ‡∏•‡∏∞ Certificate (NEW) */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); color: white; display: none; 
            justify-content: center; align-items: center; flex-direction: column; z-index: 1000;
            font-size: 20px;
        }
        #certificate {
            border: 5px solid #333; padding: 40px; width: 90%; max-width: 600px;
            margin: 40px auto; text-align: center; background-color: white; color: #333;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); display: none; position: fixed;
            top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1001;
        }
        #certificate h1 { color: #28a745; border-bottom: 3px double #28a745; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <h5 id="loadingText" class="mt-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏£‡∏ß‡∏°...</h5>
</div>


<div class="container">
    <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö: ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4 ‡πÅ‡∏•‡∏∞ 5</h1>
    <p>üí° **‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:** ‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° **'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°'** ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î **'‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</p>
    
    <button id="startAppBtn" style="background-color: #007bff; color: white;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4)</button>

    <div id="section3Div" style="display: none;">
        <h2 class="section-header">‚úÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3: ‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</h2>
        <p>‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4...</p>
        <button id="nextSection4Btn" style="background-color: #ffc107; color: black;" disabled>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4</button>
    </div>

    <hr>
    
    <div id="section4Div" style="display: none;">
        <h2 class="section-header">‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (Health Check)</h2>
        
        <p><strong>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong> <span id="hQName">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 1/5: [‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞]</span></p>
        
        <button id="answerHBtn" data-section="section4">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</button>
        <button id="stopHBtn" style="background-color: #ff6600; color: white;" disabled>‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        
        <div id="hStatus" class="status">‚úÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 1: [‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°]</div>
        
        <div class="audio-controls">
            <p><strong>‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô:</strong></p>
            <audio id="healthAudio" controls></audio>
        </div>
        
        <button id="nextSection5Btn" style="margin-top: 20px;" disabled>‚ñ∂Ô∏è ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4: ‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5</button>
    </div>

    <hr>

    <div id="section5Div" style="display: none;">
        <h2 class="section-header">‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà <span id="aRound">0</span>/<span id="maxASpan">7</span>)</h2>
        
        <button id="startABtn" data-section="section5">üîä ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        <button id="answerABtn" data-section="section5" disabled>üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        <button id="stopABtn" style="background-color: #ff6600; color: white;" disabled>‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>

        <div id="aStatus" class="status">‚úÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏î '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5 (7 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô)</div>
        
        <div class="audio-controls">
            <p><strong>‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô:</strong></p>
            <audio id="agreementAudio" controls></audio>
        </div>
        
        <button id="finalSaveBtn" style="margin-top: 20px; background-color: #dc3545;" disabled>üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
    </div>

</div>

<div id="certificate">
    <h1>üèÜ ‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡∏¢‡∏ö‡∏±‡∏ï‡∏£ üèÜ</h1>
    <p style="font-size: 18px;">‡∏Ç‡∏≠‡∏°‡∏≠‡∏ö‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡∏¢‡∏ö‡∏±‡∏ï‡∏£‡∏â‡∏ö‡∏±‡∏ö‡∏ô‡∏µ‡πâ‡πÅ‡∏Å‡πà</p>
    <h2 id="traineeName" style="color: #007bff; font-size: 32px; margin: 20px 0;">[‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô]</h2>
    <p style="font-size: 18px;">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ó‡∏≤‡∏á‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</p>
    <p style="margin-top: 30px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®: <span id="issueDate"></span></p>
    <button onclick="document.getElementById('certificate').style.display='none'">‡∏õ‡∏¥‡∏î</button>
</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import { v4 as uuidv4 } from 'https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/esm-browser/index.js';
    
    // --- 1. Supabase Config & Global State ---
    const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
    window.supabase = createClient(supabaseUrl, supabaseKey);

    let masterAudioChunks = [];
    let mediaRecorder = null;
    let currentUserId = uuidv4(); 
    let userName = "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠"; 

    // --- S4/S5 Module State Variables (PRIVATE) ---
    let currentHIndex = 0; 
    let isFollowUpMode = false;
    let followUpStep = 0; 
    let selectedDisease = null;
    let aRound = 0; 
    let maxH = 5; 
    let maxA = 7; 

    // --- S4/S5 Data Structures (‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤) ---

    // Section 5 Data (REGISTRATION)
    const registrationStepNames = [
        "1. ‡∏Ç‡∏≠‡∏™‡∏∞‡∏Å‡∏î‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•", 
        "2. ‡∏Ç‡∏≠‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô", 
        "3. ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠", 
        "4. ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà", 
        "5. ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞", 
        "6. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á PDPA ‡πÅ‡∏•‡∏∞‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢", 
        "7. ‡∏≠‡πà‡∏≤‡∏ô E-Consent/E-Legal" 
    ];
    // NOTE: registrationScriptFiles ‡∏Ñ‡∏∑‡∏≠ ANSWER ‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏ï‡πà‡∏≠ PROMPT ‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
    const registrationScriptFiles = [
        "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q2/health6_P1_P1Q2_1762518493530.webm", // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö: ‡∏™‡∏∞‡∏Å‡∏î‡∏ä‡∏∑‡πà‡∏≠
        "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q3/health6_P1_P1Q3_1762518514882.webm", // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö: ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
        "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q4/health6_P1_P1Q4_1762518543370.webm", // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö: ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
        "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q5/health6_P1_P1Q5_1762518584458.webm", // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö: ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
        "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q6/health6_P1_P1Q6_1762518625330.webm", // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö: ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞
        "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q7/health6_P1_P1Q7_1762518654346.webm", // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö: PDPA
        "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q8/health6_P1_P1Q8_1762518676715.webm"  // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô E-Consent
    ];

    // Section 4 Data (HEALTH CHECK) 
    const H_QUESTION_NAMES = [
        "1. ‡πÇ‡∏£‡∏Ñ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡∏´‡∏±‡∏ß‡πÉ‡∏à, ‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏á ‡∏Ø‡∏•‡∏Ø)", "2. ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î/‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ï‡∏±‡∏ß", "3. ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ",
        "4. ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏≠‡∏∑‡πà‡∏ô", "5. ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î"
    ];
    const F_QUESTION_NAMES = {
        1: "F1: ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà", 
        2: "F2: ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£", 
        3: "F3: ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå", 
        4: "F4: ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà", 
        5: "F5: ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£" 
    };
    const NO_ANSWER_URL = "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q3/health5_P1_P1Q3_1762340907852.webm"; 
    const CHANCE_OF_YES = 0.35; 
    const MAX_FOLLOW_UP_STEPS = 5; 
    const DISEASE_POOL = [
        { 
            name: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á", 
            yesTriggerUrl: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q1_9f79f14f-6b49-4215-a8d2-6c290175845c.webm", 
            followUp: {
                1: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q2_7a0089f6-fad2-4264-84dc-e4a9fd76bf9d.webm", 
                2: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q3_5b21f4b1-a1f1-4f87-823c-32bcee3a1e35.webm", 
                3: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q4_1ca0ed14-8f32-4067-a270-a369a475f852.webm", 
                4: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q5_172736d1-1e8f-4149-914a-66eafbc64efd.webm", 
                5: "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/4e1a6a7a-3666-4a39-a3ca-9e9b87a5f2de/part1/q6_ff573737-1694-49ce-bf5a-d2853dd0b2ae.webm" 
            }
        },
        // NOTE: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏Ñ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ñ‡∏π‡∏Å‡∏•‡∏∞‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö 
    ];

    // --- S4 Logic Functions (‡∏ï‡∏£‡∏£‡∏Å‡∏∞ playDynamicHealthQuestion ‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î) ---
    function initializeState(params) {
        currentHIndex = 0; isFollowUpMode = false; followUpStep = 0; selectedDisease = null;
        aRound = 0; maxH = params.maxH; maxA = params.maxA;
    }
    function updateHealthQuestionUI() {
        const hQName = document.getElementById("hQName");
        const answerHBtn = document.getElementById("answerHBtn");
        if (isFollowUpMode) {
            hQName.textContent = `‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ: ${selectedDisease.name} (${F_QUESTION_NAMES[followUpStep]})`;
            answerHBtn.textContent = 'üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ';
        } else if (currentHIndex < maxH) {
             hQName.textContent = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${currentHIndex + 1}/${maxH}: ${H_QUESTION_NAMES[currentHIndex]}`;
             answerHBtn.textContent = 'üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û';
        } else {
             hQName.textContent = `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô`;
        }
    }
    function initSection4(DOM) {
        DOM.section3Div.style.display = 'none'; DOM.section4Div.style.display = 'block';
        DOM.nextSection5Btn.disabled = true; DOM.answerHBtn.disabled = true;
        currentHIndex = 0; isFollowUpMode = false; followUpStep = 0; selectedDisease = null;
        updateHealthQuestionUI(); 
        DOM.answerHBtn.disabled = false; 
        DOM.hStatusElement.textContent = `‚úÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 1: ${H_QUESTION_NAMES[0]}`; 
        alert("‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3 ‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (5 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)");
    }
    function startFollowUpQuestion() {
        const healthAudio = document.getElementById("healthAudio");
        const hStatusElement = document.getElementById("hStatus");
        const answerHBtn = document.getElementById("answerHBtn");
        if (!selectedDisease || followUpStep > MAX_FOLLOW_UP_STEPS) return; 
        const currentQName = F_QUESTION_NAMES[followUpStep];
        updateHealthQuestionUI(); 
        answerHBtn.disabled = true;
        hStatusElement.textContent = `‚è≥ (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...`; 
        setTimeout(() => {
            healthAudio.pause();
            hStatusElement.textContent = `üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ: ${currentQName}`; 
            answerHBtn.disabled = false;
        }, 700); 
    }
    
    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô playDynamicHealthQuestion ‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (1, 2, 3, 5 = No; 4 = Yes/Random) ---
    function playDynamicHealthQuestion() {
        const healthAudio = document.getElementById("healthAudio");
        const hStatusElement = document.getElementById("hStatus");
        const answerHBtn = document.getElementById("answerHBtn");
        const nextSection5Btn = document.getElementById("nextSection5Btn");
        answerHBtn.disabled = true;

        if (isFollowUpMode) {
            // ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ (‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡πÄ‡∏î‡∏¥‡∏°)
            const customerAnswerUrl = selectedDisease.followUp[followUpStep];
            healthAudio.src = customerAnswerUrl; healthAudio.load();
            hStatusElement.textContent = `‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ${F_QUESTION_NAMES[followUpStep]} (‡πÇ‡∏£‡∏Ñ: ${selectedDisease.name})...`;
            healthAudio.onloadeddata = () => { healthAudio.play(); hStatusElement.textContent = `üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...`; };
            healthAudio.onended = () => {
                followUpStep++;
                if (followUpStep > MAX_FOLLOW_UP_STEPS) {
                    isFollowUpMode = false; selectedDisease = null; followUpStep = 0; currentHIndex++; 
                    if (currentHIndex < maxH) {
                        updateHealthQuestionUI(); hStatusElement.textContent = `‚úÖ ‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${currentHIndex + 1}/${maxH}`;
                        answerHBtn.disabled = false; 
                    } else {
                        updateHealthQuestionUI(); nextSection5Btn.disabled = false;
                        hStatusElement.textContent = `üéâ ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ñ‡∏£‡∏ö ${maxH} ‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5`;
                    }
                } else {
                    startFollowUpQuestion();
                }
            };
        } else {
            // ‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
            if (currentHIndex >= maxH) {
                nextSection5Btn.disabled = false; hStatusElement.textContent = `üéâ ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ñ‡∏£‡∏ö ${maxH} ‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5`;
                return;
            }
            
            let isYes;
            
            if (currentHIndex === 3) {
                // ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 4 (Index 3): ‡∏™‡∏∏‡πà‡∏°‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ -> YES (‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÇ‡∏£‡∏Ñ)
                isYes = true;
            } else if (currentHIndex === 0 || currentHIndex === 1 || currentHIndex === 2 || currentHIndex === 4) {
                // ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà 1, 2, 3, 5 (Index 0, 1, 2, 4): ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢ -> NO
                isYes = false;
            } else {
                // Fallback (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ maxH ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
                isYes = Math.random() < CHANCE_OF_YES; 
            }

            if (isYes) {
                // (Yes logic)
                const randomIndex = Math.floor(Math.random() * DISEASE_POOL.length);
                selectedDisease = DISEASE_POOL[randomIndex]; 
                isFollowUpMode = true; 
                followUpStep = 1; 
                healthAudio.src = selectedDisease.yesTriggerUrl; healthAudio.load();
                hStatusElement.textContent = `‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: "‡πÉ‡∏ä‡πà" (‡πÇ‡∏£‡∏Ñ: ${selectedDisease.name})...`;
                healthAudio.onloadeddata = () => { healthAudio.play(); hStatusElement.textContent = `üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: "‡πÉ‡∏ä‡πà" (‡πÇ‡∏£‡∏Ñ: ${selectedDisease.name})...`; };
                healthAudio.onended = () => { startFollowUpQuestion(); };
            } else {
                // (No logic)
                healthAudio.src = NO_ANSWER_URL; healthAudio.load();
                hStatusElement.textContent = `‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: "‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏Ñ‡πà‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö"...`;
                healthAudio.onloadeddata = () => { healthAudio.play(); hStatusElement.textContent = `üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: "‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏Ñ‡πà‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö"...`; };
                healthAudio.onended = () => {
                    currentHIndex++; 
                    if (currentHIndex < maxH) {
                        updateHealthQuestionUI(); hStatusElement.textContent = `‚úÖ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏∑‡∏≠ '‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢' ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${currentHIndex + 1}/${maxH}`;
                        answerHBtn.disabled = false; 
                    } else {
                        updateHealthQuestionUI(); nextSection5Btn.disabled = false;
                        hStatusElement.textContent = `üéâ ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ñ‡∏£‡∏ö ${maxH} ‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5`;
                    }
                };
            }
        }
    }


    // --- SECTION 5 LOGIC (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) ---
    function initSection5(DOM) {
        DOM.section4Div.style.display = 'none';
        DOM.section5Div.style.display = 'block';

        DOM.nextSection5Btn.disabled = true;
        
        DOM.startABtn.style.display = 'block';
        DOM.startABtn.disabled = false;
        DOM.answerABtn.disabled = true;
        DOM.stopABtn.disabled = true;
        DOM.finalSaveBtn.disabled = true;
        
        aRound = 0; 
        
        document.getElementById("aRound").textContent = aRound; 
        DOM.aStatusElement.textContent = `‚úÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4 ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏î '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1/${maxA} (7 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô)`; 
        document.getElementById("maxASpan").textContent = maxA;
        alert("‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4 ‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (7 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô)");
    }

    function prepareAgentRecording(roundIndex) {
        const aRoundSpan = document.getElementById("aRound");
        const aStatusElement = document.getElementById("aStatus");
        const answerABtn = document.getElementById("answerABtn");
        const startABtn = document.getElementById("startABtn");
        
        const currentStepName = registrationStepNames[roundIndex];
        
        aRoundSpan.textContent = roundIndex + 1;
        
        aStatusElement.textContent = `üé§ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${roundIndex + 1}/${maxA}: ${currentStepName}`; 
        answerABtn.disabled = false;
        
        if (roundIndex === 0) {
            startABtn.style.display = 'none'; 
        }
    }

    function playCustomerRegistrationResponse() {
        const agreementAudio = document.getElementById("agreementAudio");
        const aStatusElement = document.getElementById("aStatus");
        const finalSaveBtn = document.getElementById("finalSaveBtn");
        const answerABtn = document.getElementById("answerABtn");
        
        const roundIndex = aRound; 
        
        if (roundIndex >= maxA) return;

        const selectedFile = registrationScriptFiles[roundIndex]; 
        
        agreementAudio.src = selectedFile;
        agreementAudio.load();

        aStatusElement.textContent = `‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${roundIndex + 1}/${maxA}...`; 
        
        answerABtn.disabled = true;

        agreementAudio.onloadeddata = () => {
            agreementAudio.play();
            aStatusElement.textContent = `üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${registrationStepNames[roundIndex]}...`; 
        };
        
        agreementAudio.onended = () => {
            aRound++; 

            if (aRound < maxA) {
                prepareAgentRecording(aRound); 
            } else {
                // ‡∏à‡∏ö S5
                aStatusElement.textContent = "üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î'"; 
                finalSaveBtn.disabled = false;
                answerABtn.disabled = true;
            }
        };
    }


    // --- MASTER RECORDING & UPLOAD LOGIC (FIXED) ---

    async function startMasterRecording() {
        if (mediaRecorder && mediaRecorder.state === "recording") return;
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            masterAudioChunks = []; 
            
            mediaRecorder.ondataavailable = e => { 
                if (e.data.size > 0) masterAudioChunks.push(e.data);
            };

            mediaRecorder.onstart = () => { console.log("Master recording started."); };
            
            mediaRecorder.onstop = () => {
                stream.getTracks().forEach(track => track.stop());
                console.log("Master recording stopped. Chunks collected:", masterAudioChunks.length);
            };
            
            mediaRecorder.start();
            console.log("Microphone access successful. Master recording running in background.");
        } catch (err) {
            console.error("‚ùå Error accessing microphone for master recording:", err);
            alert(`‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô: ${err.name}. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå. ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ.`);
        }
    }

    function stopAndSaveMasterRecording() {
        if (!mediaRecorder || mediaRecorder.state !== "recording") {
            alert("Master Recording ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô.");
            return;
        }

        const finalSaveBtn = document.getElementById('finalSaveBtn');
        finalSaveBtn.disabled = true;
        finalSaveBtn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...";
        
        mediaRecorder.stop(); 

        setTimeout(() => {
            if (masterAudioChunks.length === 0) {
                alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ! ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô");
                finalSaveBtn.disabled = false;
                finalSaveBtn.textContent = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î";
                return;
            }

            const audioBlob = new Blob(masterAudioChunks, { type: 'audio/webm' });
            uploadFinalRecording(audioBlob).then(success => {
                if (success) {
                    finalSaveBtn.textContent = "‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!";
                    showCertificate();
                } else {
                    finalSaveBtn.disabled = false;
                    finalSaveBtn.textContent = "‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
                }
            });
        }, 500); 
    }
    
    async function uploadFinalRecording(audioBlob) {
        const loadingOverlay = document.getElementById("loadingOverlay");
        const loadingText = document.getElementById("loadingText");
        
        loadingOverlay.style.display = "flex";
        loadingText.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏ô‡∏≤‡∏î ${(audioBlob.size / (1024 * 1024)).toFixed(2)} MB...`;

        if (userName === "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠") {
            const nameInput = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:");
            userName = nameInput ? nameInput : `Anon_${currentUserId.substring(0, 8)}`;
        }

        try {
            const fileName = `${currentUserId}/final/full_session_${uuidv4()}.webm`;
            const { error: uploadError } = await window.supabase.storage
                .from('responses') 
                .upload(fileName, audioBlob, { upsert: false });
            if (uploadError) { throw uploadError; }

            const { data: { publicUrl } } = window.supabase.storage.from('responses').getPublicUrl(fileName);
            loadingText.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...`;
            
            // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ (email, part_number, question_number) ---
            const { error: insertError } 
                = await window.supabase
                .from('submissions') 
                .insert([
                    {
                        user_id: currentUserId,
                        name: userName, 
                        email: `anon_${currentUserId}@roleplay.com`, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
                        part_number: 99, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
                        question_number: 0, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
                        question_text: `Final Full Roleplay Session (S4 & S5)`, 
                        audio_url: publicUrl,
                        duration_seconds: audioBlob.size > 0 ? (audioBlob.size / 100000) : 0 
                    }
                ]);
            if (insertError) { 
                 // ‡πÅ‡∏™‡∏î‡∏á error object ‡πÉ‡∏ô console ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Debug
                 console.error('Supabase Insert Error:', insertError); 
                 throw insertError; 
            }
            // --------------------------------------------------------------------------

            loadingText.textContent = `‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!`;
            setTimeout(() => { loadingOverlay.style.display = "none"; }, 1000);
            return true;
        } catch (err) {
            console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î:', err);
            alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î: ${err.message || '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö console ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Supabase Error.'}. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Internet/RLS.`);
            loadingOverlay.style.display = "none";
            return false;
        }
    }

    function showCertificate() {
        const nameInput = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®):", userName);
        const finalName = nameInput ? nameInput : userName;
        
        document.getElementById("traineeName").textContent = finalName;
        const today = new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById("issueDate").textContent = today;
        document.getElementById("certificate").style.display = "block";
    }

    // --- Main Application Setup & Simulation Functions (FIXED) ---

    const DOM = {
        section3Div: document.getElementById('section3Div'), section4Div: document.getElementById('section4Div'), section5Div: document.getElementById('section5Div'),
        hQName: document.getElementById('hQName'), hStatusElement: document.getElementById('hStatus'), answerHBtn: document.getElementById('answerHBtn'), stopHBtn: document.getElementById('stopHBtn'), healthAudio: document.getElementById('healthAudio'), nextSection5Btn: document.getElementById('nextSection5Btn'),
        aStatusElement: document.getElementById('aStatus'), startABtn: document.getElementById('startABtn'), answerABtn: document.getElementById('answerABtn'), stopABtn: document.getElementById('stopABtn'), agreementAudio: document.getElementById('agreementAudio'), finalSaveBtn: document.getElementById('finalSaveBtn'), maxA: 7,
        loadingOverlay: document.getElementById("loadingOverlay")
    };

    let isRecording = false; 

    function startRecording(sectionId) {
        if (!mediaRecorder) {
             startMasterRecording(); 
             DOM.answerHBtn.disabled = true; 
        }
        
        if (isRecording) return;
        isRecording = true;
        
        if (sectionId === 'section4') {
            DOM.answerHBtn.disabled = true;
            DOM.stopHBtn.disabled = false;
            DOM.hStatusElement.textContent = 'üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...';
            DOM.healthAudio.pause(); 
        } else if (sectionId === 'section5') {
            DOM.answerABtn.disabled = true;
            DOM.stopABtn.disabled = false;
            DOM.aStatusElement.textContent = 'üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...';
            DOM.agreementAudio.pause(); 
        }
    }

    function stopRecording(sectionId) {
        if (!isRecording) return;
        isRecording = false;
        
        if (sectionId === 'section4') {
            DOM.stopHBtn.disabled = true;
        } else if (sectionId === 'section5') {
            DOM.stopABtn.disabled = true;
        }

        onRecordingStopped(sectionId);
    }

    function onRecordingStopped(sectionId) {
        if (sectionId === 'section4') {
            playDynamicHealthQuestion();
        } else if (sectionId === 'section5') {
            playCustomerRegistrationResponse();
        }
    }

    function setupListeners() {
        document.getElementById('startAppBtn').addEventListener('click', () => {
            document.getElementById('startAppBtn').style.display = 'none';
            initSection4(DOM);
        });

        // S4 Listeners 
        DOM.answerHBtn.addEventListener('click', (e) => startRecording(e.target.dataset.section));
        DOM.stopHBtn.addEventListener('click', (e) => stopRecording('section4'));
        DOM.nextSection5Btn.addEventListener('click', () => initSection5(DOM));

        // S5 Listeners
        DOM.startABtn.addEventListener('click', () => {
            aRound = 0; 
            prepareAgentRecording(aRound); 
        });
        DOM.answerABtn.addEventListener('click', (e) => startRecording(e.target.dataset.section));
        DOM.stopABtn.addEventListener('click', (e) => stopRecording('section5'));

        // FINAL STEP 
        DOM.finalSaveBtn.addEventListener('click', stopAndSaveMasterRecording);
    }

    function initApp() {
        initializeState({ maxH: 5, maxA: 7 });
        DOM.section4Div.style.display = 'none';
        DOM.section5Div.style.display = 'none';
        setupListeners();
    }

    document.addEventListener('DOMContentLoaded', initApp);

</script>

</body>
</html>
